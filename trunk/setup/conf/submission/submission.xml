<web-app xmlns="http://caucho.com/ns/resin"
	xmlns:resin="urn:java:com.caucho.resin"
	xmlns:mireka="urn:java:mireka"
	xmlns:subetha="urn:java:org.subethamail.smtp.server"
	xmlns:subethaauth="urn:java:org.subethamail.smtp.auth"
	xmlns:concurrent="urn:java:java.util.concurrent"
	xmlns:ee="urn:java:ee"
	>
	
	<!-- 
		Comment out if mails will be relayed through the backend server.
		In that case queues are not necessary. 
	-->
	<resin:import path="${__DIR__}/queues.xml" />
	
	<mireka:RecipientTable>
		<Named>submissionRecipientTable</Named>

		<mireka:mapper>
			#{localRecipientsTable}
		</mireka:mapper>
		
		<mireka:mapper>
			<mireka:RecipientSpecificationDestinationPair>
				<mireka:recipientSpecification>
					<mireka:AnyRecipient />
				</mireka:recipientSpecification>
				<mireka:destination>
					<!-- 
						comment out if all mails will be 
						relayed through the backend 
						server
					-->
					<mireka:TransmitterDestination />
					
					<!-- 
						uncomment to relay all mail to 
						the backend server 
					-->
					<!--
					<mireka:RelayDestination>
						<mireka:backendServer>
							#{backendServer}
						</mireka:backendServer>
					</mireka:RelayDestination>
					-->
				</mireka:destination>
				
			</mireka:RecipientSpecificationDestinationPair>
		</mireka:mapper>
	</mireka:RecipientTable>

	<resource name="submissionTrafficSummary" 
			mbean-name="mireka:type=TrafficSummary,name=Submission"
			type="mireka.filter.misc.TrafficSummary" />
			
	<mireka:Filters>
		<Named>submissionFilters</Named>
		
		<mireka:filter>
			<mireka:MeasureTraffic>
				<mireka:trafficSummary>
					#{submissionTrafficSummary}
				</mireka:trafficSummary>
			</mireka:MeasureTraffic>
		</mireka:filter>
		<mireka:filter>
			<mireka:RejectIfUnauthenticated>
				<mireka:authenticatedSpecification>
					<mireka:SmtpAuthenticated/>
				</mireka:authenticatedSpecification>
				<mireka:authenticatedSpecification>
					<mireka:ConnectedFromAuthorizedIpAddress>
						<resin:import path="${__DIR__}/authorized-ip.xml" />
					</mireka:ConnectedFromAuthorizedIpAddress>
				</mireka:authenticatedSpecification>
			</mireka:RejectIfUnauthenticated>
		</mireka:filter>
		<mireka:filter>
			<mireka:LookupDestination>
				<mireka:recipientDestinationMapper>
					#{submissionRecipientTable}
				</mireka:recipientDestinationMapper>
			</mireka:LookupDestination>
		</mireka:filter>
		<mireka:filter>
			<mireka:RejectLargeMail/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptGlobalPostmaster/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptDomainPostmaster/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptAllRecipient />
		</mireka:filter>
		<mireka:filter>
			<mireka:SavePostmasterMail>
				<mireka:dir>${mirekaHome}/postmaster</mireka:dir>
			</mireka:SavePostmasterMail>
		</mireka:filter>
		<mireka:filter>
			<mireka:StopLoop />
		</mireka:filter>
		<mireka:filter>
			<mireka:TransmitFilter>
				<mireka:transmitter>
					#{primaryTransmitter}
				</mireka:transmitter>
			</mireka:TransmitFilter>
		</mireka:filter>
		<mireka:filter>
			<mireka:RelayMailTransaction />
		</mireka:filter>
		<mireka:filter>
			<mireka:MaildropFilter>
				<mireka:maildropRepository>
					#{maildropRepository}
				</mireka:maildropRepository>
			</mireka:MaildropFilter>
		</mireka:filter>
		<mireka:filter>
			<mireka:MailingListFilter />
		</mireka:filter>
	</mireka:Filters>
	
	<mireka:UsernamePasswordValidatorImpl>
		<Named>usernamePasswordValidator</Named>
		
		<mireka:loginSpecification>
			<mireka:GlobalUsersLoginSpecification>
				<mireka:users>#{globalUsers}</mireka:users>
			</mireka:GlobalUsersLoginSpecification>
		</mireka:loginSpecification>
	</mireka:UsernamePasswordValidatorImpl>

	<mireka:MessageHandlerFactoryImpl>
		<Named>submissionMessageHandler</Named>
		<mireka:filters>#{submissionFilters}</mireka:filters>
	</mireka:MessageHandlerFactoryImpl>

	<subethaauth:EasyAuthenticationHandlerFactory>
		<Named>authenticationHandlerFactory</Named>
		<new>#{usernamePasswordValidator}</new>
	</subethaauth:EasyAuthenticationHandlerFactory>
	
	<subetha:SMTPServer>
		<Named>submissionServer</Named>
		<new>
			#{submissionMessageHandler}
		</new>
		<subetha:authenticationHandlerFactory>
			#{authenticationHandlerFactory}
		</subetha:authenticationHandlerFactory>
		<subetha:port>587</subetha:port>
		<subetha:hostName>${helo}</subetha:hostName>
		<subetha:hideTLS>true</subetha:hideTLS>
	</subetha:SMTPServer>
	
	<mireka:SMTPService>
		<Named>submission</Named>
		<ee:Startup/>
		<mireka:smtpServer>#{submissionServer}</mireka:smtpServer>
		<!-- <mireka:bindAddress>192.0.2.0</mireka:bindAddress> -->
	</mireka:SMTPService>
	
</web-app>