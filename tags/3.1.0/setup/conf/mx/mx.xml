<!-- 
	Public SMTP service configuration. This is the service which usually 
	runs on port 25.
	
	For more information on the individual configuration elements see the 
	Javadoc documentation in the doc/javadoc directory. For an overview read
	the documentation in the doc directory.  
-->
<web-app xmlns="http://caucho.com/ns/resin"
	xmlns:resin="urn:java:com.caucho.resin"
	xmlns:mireka="urn:java:mireka"
	xmlns:subetha="urn:java:org.subethamail.smtp.server"
	xmlns:ee="urn:java:ee"
	>
	
	<!--
		Accepted recipients for the proxy mode. Mails to these 
		recipients will be relayed to a backend server. 
		
		Note: In order to make most of this file identical for both
		proxy and standalone server mode, this list is allowed to have 
		a common subset with the localRecipientsTable 
		(defined in mireka.xml). This does not cause any problem,
		because that table is queried first, so it has a 
		higher priority (see below). If a recipient here also 
		appears on the localRecipientsTable, then a mail addressed to 
		the recipient will not be relayed, but it will be delivered 
		according to its destination assigned in localRecipientsTable.
	-->
	<mireka:RecipientSpecifications>
		<Named>relayedRecipients</Named>
		
		<mireka:specification>
			<mireka:GlobalPostmasterSpecification />
		</mireka:specification>

		<!-- this matches Postmaster@... addresses for any domain, not 
			only for local domains, but non-local ones will be 
			rejected by the ProhibitRelaying filter anyway --> 
		<mireka:specification>
			<mireka:AnyDomainPostmaster />
		</mireka:specification>		
		
		<mireka:specification>
			<mireka:InlineRecipientRegistry>
				<resin:import path="${__DIR__}/individual-recipients.xml" />
			</mireka:InlineRecipientRegistry>
		</mireka:specification>
	
		<mireka:specification>
			<mireka:GlobalUsersRecipientSpecification>
				<mireka:users>#{globalUsers}</mireka:users>
			</mireka:GlobalUsersRecipientSpecification>
		</mireka:specification>
		
		<resin:import path="${__DIR__}/wildcard-recipients.xml" />
		
	</mireka:RecipientSpecifications>

	<!--
		This table specifies valid recipients and assigns destinations 
		to them. 
	-->
	<mireka:RecipientTable>
		<Named>recipientTable</Named>
	
		<!-- 
			Any recipient included in the localRecipientsTable
			will be delivered according to that table.
		-->
		<mireka:mapper>
			#{localRecipientsTable}
		</mireka:mapper>
		
		<!--
			Any other recipient, which is still valid according to
			the relayedRecipients table above, 
			is relayed to the backend server.
		-->
		<mireka:mapper>
			<mireka:RecipientSpecificationDestinationPair>
				<mireka:recipientSpecification>
					#{relayedRecipients}
				</mireka:recipientSpecification>
				<mireka:destination>
					<mireka:RelayDestination>
						<mireka:backendServer>
							#{backendServer}
						</mireka:backendServer>
					</mireka:RelayDestination>
				</mireka:destination>
			</mireka:RecipientSpecificationDestinationPair>
		</mireka:mapper>
		
	</mireka:RecipientTable>
	
	<resource name="mxTrafficSummary" mbean-name="mireka:type=TrafficSummary,name=MX"
			type="mireka.filter.misc.TrafficSummary" />
	
	<!--
		The filter chain.
		
		It is unlikely that you need to change this, except if you use
		a custom filter.
	-->
	<mireka:Filters>
		<Named>mxFilters</Named>
		
		<mireka:filter>
			<mireka:MeasureTraffic>
				<mireka:trafficSummary>
					#{mxTrafficSummary}
				</mireka:trafficSummary>
			</mireka:MeasureTraffic>
		</mireka:filter>
		<mireka:filter>
			<mireka:LookupDestinationFilter>
				<mireka:recipientDestinationMapper>
					#{recipientTable}
				</mireka:recipientDestinationMapper>
			</mireka:LookupDestinationFilter>
		</mireka:filter>
		<mireka:filter>
			<mireka:RejectLargeMail/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AddReceivedSpfHeader/>
		</mireka:filter>
		<mireka:filter>
			<mireka:TarpitOnGlobalRejections/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptGlobalPostmaster/>
		</mireka:filter>
		<mireka:filter>
			<mireka:ProhibitRelaying>
				<mireka:localDomainSpecification>
					#{localDomains}
				</mireka:localDomainSpecification>
			</mireka:ProhibitRelaying>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptDomainPostmaster/>
		</mireka:filter>
		<mireka:filter>
			<mireka:RefuseBlacklistedRecipient>
				<mireka:blacklist>
					<mireka:Dnsbl>
						<mireka:domain>zen.spamhaus.org.</mireka:domain>
					</mireka:Dnsbl>
				</mireka:blacklist>
			</mireka:RefuseBlacklistedRecipient>
		</mireka:filter>
		<mireka:filter>
			<mireka:RefuseUnknownRecipient />
		</mireka:filter>
		<mireka:filter>
			<mireka:RejectOnFailedSpfCheck />
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptAllRecipient />
		</mireka:filter>
		<mireka:filter>
			<mireka:SavePostmasterMail>
				<mireka:dir>${mirekaHome}/postmaster</mireka:dir>
			</mireka:SavePostmasterMail>
		</mireka:filter>
		<mireka:filter>
			<mireka:StopLoop />
		</mireka:filter>
		<mireka:filter>
			<mireka:DestinationProcessorFilter />
		</mireka:filter>
	</mireka:Filters>
	
	<!-- Do not change this -->
	<mireka:MessageHandlerFactoryImpl>
		<Named>mxMessageHandler</Named>
		<mireka:filters>#{mxFilters}</mireka:filters>
	</mireka:MessageHandlerFactoryImpl>

	<!--
		Configure server name, bind address, etc. here.
	-->
	<mireka:SMTPServer>
		<Named>mx</Named>
		<ee:Startup/>
		<new>
			#{mxMessageHandler}
		</new>
		<mireka:hostName>${helo}</mireka:hostName>
		<!-- <mireka:bindAddress>192.0.2.0</mireka:bindAddress> -->
		<!-- uncomment to enable STARTTLS if JSSE is correctly configured -->
		<!-- <mireka:enableTLS>true</mireka:enableTLS> -->
	</mireka:SMTPServer>
	
</web-app>